<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HBIRD V4 Full Test</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: monospace; padding:20px; background:#111; color:#eee; }
    button, input { margin:6px; padding:10px; font-size:15px; border-radius:8px; }
    button { cursor:pointer; }
    #debug { background:#000; color:#0f0; padding:10px; height:320px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h2>HBIRD V4 Full Test</h2>
  
  <div>
    <button id="connectBtn">🔌 Connect Wallet</button>
    <button id="poolBtn" disabled>💰 Check Pool</button>
    <button id="nonceBtn" disabled>🔎 Auto Nonce</button>
    <button id="approveBtn" disabled>✅ Approve HBIRD</button>
    <button id="depositBtn" disabled>📥 Deposit HBIRD</button>
    <button id="claimBtn" disabled>🎁 Claim Reward</button>
  </div>
  
  <div>
    Amount HBIRD: <input id="amountInput" type="number" min="1" value="100">
    Manual Nonce: <input id="manualNonce" type="number" min="0" value="0">
  </div>
  
  <h3>Debug Log</h3>
  <div id="debug"></div>

<script>
const debugBox = document.getElementById("debug");
function log(msg) {
  console.log(msg);
  debugBox.textContent += `[${new Date().toISOString()}] ${msg}\n`;
  debugBox.scrollTop = debugBox.scrollHeight;
}

let provider, signer, account;

const TOKEN_ADDR   = "0x5d9C011F4C8aD8efB4252f17e870085936CE296B"; 
const CONTRACT_V4  = "0xb9ccd00c2016444f58e2492117b49da317f4899b"; 

const ABI = [
  "function getPoolBalance() view returns (uint256)",
  "function usedNonces(address player,uint256 nonce) view returns (bool)",
  "function claimReward(uint256 amount,uint256 nonce,uint256 expiry,bytes signature) external",
  "function deposit(uint256 amount) external"
];

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)"
];

const heliosChain = {
  chainId: "0xa410", // 42000
  chainName: "Helios Testnet",
  nativeCurrency: { name: "Helios", symbol: "tHELIOS", decimals: 18 },
  rpcUrls: ["https://testnet1.helioschainlabs.org"],
  blockExplorerUrls: ["https://explorer.helioschainlabs.org"],
};

// Connect Wallet
document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) return log("❌ Wallet not found");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  log("🔌 Connected: " + account);

  const net = await provider.getNetwork();
  if (net.chainId !== 42000) {
    log("⚠️ Wrong network. Switching...");
    await window.ethereum.request({ method: "wallet_addEthereumChain", params: [heliosChain] });
  } else {
    log("✅ On Helios Testnet");
  }

  ["poolBtn","nonceBtn","approveBtn","depositBtn","claimBtn"].forEach(id=>{
    document.getElementById(id).disabled = false;
  });
};

// Check Pool
document.getElementById("poolBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(CONTRACT_V4, ABI, provider);
    const bal = await contract.getPoolBalance();
    log("Pool balance: " + ethers.utils.formatUnits(bal,18) + " HBIRD");
  } catch (e) {
    log("❌ Pool check failed: " + e.message);
  }
};

// Auto Nonce
document.getElementById("nonceBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(CONTRACT_V4, ABI, provider);
    let n = 0;
    while (await contract.usedNonces(account, n)) n++;
    document.getElementById("manualNonce").value = n;
    log("Auto Nonce: " + n);
  } catch (e) {
    log("❌ Auto Nonce error: " + e.message);
  }
};

// Approve HBIRD
document.getElementById("approveBtn").onclick = async () => {
  try {
    const amount = document.getElementById("amountInput").value;
    const token = new ethers.Contract(TOKEN_ADDR, ERC20_ABI, signer);
    const tx = await token.approve(CONTRACT_V4, ethers.utils.parseUnits(amount,18));
    log("⛓️ Approve TX sent: " + tx.hash);
    await tx.wait();
    log("✅ Approve confirmed");
  } catch (e) {
    log("❌ Approve error: " + e.message);
  }
};

// Deposit HBIRD
document.getElementById("depositBtn").onclick = async () => {
  try {
    const amount = document.getElementById("amountInput").value;
    const contract = new ethers.Contract(CONTRACT_V4, ABI, signer);
    const tx = await contract.deposit(ethers.utils.parseUnits(amount,18));
    log("⛓️ Deposit TX sent: " + tx.hash);
    await tx.wait();
    log("✅ Deposit confirmed");
  } catch (e) {
    log("❌ Deposit error: " + e.message);
  }
};

// Claim Reward
document.getElementById("claimBtn").onclick = async () => {
  try {
    const amount = document.getElementById("amountInput").value;
    let nonce = document.getElementById("manualNonce").value;

    // ambil voucher dari backend
    const backendUrl = "https://birdfunbackend.vercel.app/api/sign";
    const url = `${backendUrl}?player=${account}&amount=${amount}&nonce=${nonce}&contractAddress=${CONTRACT_V4}`;
    log("Fetching voucher: " + url);

    const res = await fetch(url);
    const voucher = await res.json();
    log("Voucher: " + JSON.stringify(voucher));

    if (!voucher.signature) return log("❌ Voucher failed");

    const contract = new ethers.Contract(CONTRACT_V4, ABI, signer);
    const tx = await contract.claimReward(
      voucher.amountWei,
      voucher.nonce,
      voucher.expiry,
      voucher.signature
    );
    log("⛓️ Reward TX sent: " + tx.hash);
    const rc = await tx.wait();
    log("✅ Reward Claimed, block " + rc.blockNumber);
  } catch (e) {
    log("❌ Claim error: " + e.message);
  }
};
</script>
</body>
</html>