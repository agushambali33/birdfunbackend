<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HBIRD Voucher Test (Final)</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: monospace; padding:20px; background:#111; color:#eee; }
    button { margin:6px; padding:10px; font-size:15px; border-radius:8px; cursor:pointer; }
    input { margin:6px; padding:6px; width:120px; }
    #debug { background:#000; color:#0f0; padding:10px; height:360px; overflow:auto; white-space:pre-wrap; }
    a { color:#0ff; text-decoration:none; }
  </style>
</head>
<body>
  <h2>HBIRD Voucher + Reward Test</h2>
  
  <div>
    <button id="connectBtn">🔌 Connect Wallet</button>
    <button id="poolBtn" disabled>💰 Check Pool</button>
    <button id="autoNonceBtn" disabled>🔎 Auto Nonce</button>
    <button id="checkNonceBtn" disabled>📝 Debug Nonce</button>
    <button id="claimRewardBtn" disabled>🐦 Claim Reward</button>
  </div>
  
  <div>
    Manual Nonce: <input id="manualNonce" type="number" min="0" value="0">
    Amount HBIRD: <input id="amountInput" type="number" min="1" value="100">
  </div>
  
  <h3>Debug Log</h3>
  <div id="debug"></div>

<script>
const debugBox = document.getElementById("debug");
function log(msg) {
  console.log(msg);
  debugBox.textContent += `[${new Date().toISOString()}] ${msg}\n`;
  debugBox.scrollTop = debugBox.scrollHeight;
}

let provider, signer, account;
const CONTRACT = "0xb9ccd00c2016444f58e2492117b49da317f4899b"; 
const TOKEN    = "0x5d9C011F4C8aD8efB4252f17e870085936CE296B"; 

const ABI = [
  "function claimReward(uint256 amount,uint256 nonce,uint256 expiry,bytes signature) external",
  "function getPoolBalance() view returns (uint256)",
  "function lastNonce(address player) view returns (uint256)"
];

const heliosChain = {
  chainId: "0xa410", // 42000
  chainName: "Helios Testnet",
  nativeCurrency: { name: "Helios", symbol: "tHELIOS", decimals: 18 },
  rpcUrls: ["https://testnet1.helioschainlabs.org"],
  blockExplorerUrls: ["https://explorer.helioschainlabs.org"],
};

// Connect Wallet
document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) return log("❌ Wallet not found");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  log("🔌 Connected: " + account);

  const net = await provider.getNetwork();
  if (net.chainId !== 42000) {
    log("⚠️ Wrong network. Switching...");
    await window.ethereum.request({ method: "wallet_addEthereumChain", params: [heliosChain] });
  } else {
    log("✅ On Helios Testnet");
  }

  ["poolBtn","autoNonceBtn","checkNonceBtn","claimRewardBtn"].forEach(id=>{
    document.getElementById(id).disabled = false;
  });
};

// Check Pool
document.getElementById("poolBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(CONTRACT, ABI, provider);
    const bal = await contract.getPoolBalance();
    log("💰 Pool balance: " + ethers.utils.formatUnits(bal,18) + " HBIRD");
  } catch (e) {
    log("❌ Pool check failed: " + e.message);
  }
};

// Auto Nonce (ambil lastNonce dari kontrak +1)
document.getElementById("autoNonceBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(CONTRACT, ABI, provider);
    const last = await contract.lastNonce(account);
    const next = last.toNumber() + 1;
    document.getElementById("manualNonce").value = next;
    log(`🔎 Auto Nonce: last = ${last}, next = ${next}`);
  } catch (e) {
    log("❌ Auto Nonce error: " + e.message);
  }
};

// Debug Nonce
document.getElementById("checkNonceBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(CONTRACT, ABI, provider);
    const last = await contract.lastNonce(account);
    const next = last.toNumber() + 1;
    let manual = parseInt(document.getElementById("manualNonce").value);

    log(`📝 On-chain lastNonce(${account}) = ${last}`);
    log(`➡️ Next valid nonce = ${next}`);

    if (manual <= last.toNumber()) {
      log(`⚠️ Nonce ${manual} sudah terpakai. Harus >= ${next}`);
    } else {
      log(`✅ Nonce ${manual} valid, siap dipakai.`);
    }
  } catch (e) {
    log("❌ Debug Nonce error: " + e.message);
  }
};

// Claim Reward HBIRD
document.getElementById("claimRewardBtn").onclick = async () => {
  try {
    const amount = document.getElementById("amountInput").value;
    const nonce  = document.getElementById("manualNonce").value;

    log(`Requesting voucher... amount=${amount}, nonce=${nonce}`);

    const backendUrl = "https://birdfunbackend.vercel.app/api/sign";
    const url = `${backendUrl}?player=${account}&amount=${amount}&nonce=${nonce}&contractAddress=${CONTRACT}`;
    const res = await fetch(url);
    const voucher = await res.json();
    log("📜 Voucher: " + JSON.stringify(voucher));

    if (!voucher.signature) {
      return log("❌ Voucher invalid: " + JSON.stringify(voucher));
    }

    const contract = new ethers.Contract(CONTRACT, ABI, signer);
    log("⚡ Sending claimReward tx...");
    const tx = await contract.claimReward(
      voucher.amountWei,
      voucher.nonce,
      voucher.expiry,
      voucher.signature
    );
    log("⛓️ TX sent: " + tx.hash + " (waiting...)");

    const rc = await tx.wait();
    log(`✅ Reward Claimed in block ${rc.blockNumber}`);
    log(`🔍 Explorer: https://explorer.helioschainlabs.org/tx/${tx.hash}`);
  } catch (e) {
    log("❌ Claim error: " + e.message);
  }
};
</script>
</body>
</html>