<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HBIRD Voucher + Reward Test</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: monospace; padding:20px; background:#111; color:#eee; }
    button { margin:6px; padding:10px; font-size:15px; border-radius:8px; cursor:pointer; }
    input { margin:6px; padding:6px; width:120px; }
    #debug { background:#000; color:#0f0; padding:10px; height:320px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h2>HBIRD Voucher + Reward Test</h2>
  
  <div>
    <button id="connectBtn">üîå Connect Wallet</button>
    <button id="poolBtn" disabled>üí∞ Check Pool</button>
    <button id="nonceBtn" disabled>üîé Auto Nonce</button>
    <button id="claimVoucherBtn" disabled>üéü Claim Voucher</button>
    <button id="claimRewardBtn" disabled>üê¶ Claim Reward</button>
  </div>
  
  <div>
    Manual Nonce: <input id="manualNonce" type="number" min="0" value="0">
    Points: <input id="pointsInput" type="number" min="1" value="100">
    Amount HBIRD: <input id="amountInput" type="number" min="1" value="100">
  </div>
  
  <h3>Debug Log</h3>
  <div id="debug"></div>

<script>
const debugBox = document.getElementById("debug");
function log(msg) {
  console.log(msg);
  debugBox.textContent += `[${new Date().toISOString()}] ${msg}\n`;
  debugBox.scrollTop = debugBox.scrollHeight;
}

let provider, signer, account;
const VOUCHER_CONTRACT = "0x3b807E75c5b3719B76d3ae0e4B3c9f02984f2F41"; 
const HBIRD_CONTRACT   = "0xb9ccd00c2016444f58e2492117b49da317f4899b"; 

const ABI = [
  "function redeemVoucher(address player,uint256 points,uint256 tokenAmount,uint256 nonce,uint256 expiry,bytes signature) external",
  "function getPoolBalance() view returns (uint256)",
  "function usedNonces(address player,uint256 nonce) view returns (bool)",
  "function claimReward(uint256 amount,uint256 nonce,uint256 expiry,bytes signature) external"
];

const heliosChain = {
  chainId: "0xa410", // 42000
  chainName: "Helios Testnet",
  nativeCurrency: { name: "Helios", symbol: "tHELIOS", decimals: 18 },
  rpcUrls: ["https://testnet1.helioschainlabs.org"],
  blockExplorerUrls: ["https://explorer.helioschainlabs.org"],
};

// Connect Wallet
document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) return log("‚ùå Wallet not found");
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  log("üîå Connected: " + account);

  const net = await provider.getNetwork();
  if (net.chainId !== 42000) {
    log("‚ö†Ô∏è Wrong network. Switching...");
    await window.ethereum.request({ method: "wallet_addEthereumChain", params: [heliosChain] });
  } else {
    log("‚úÖ On Helios Testnet");
  }

  ["poolBtn","nonceBtn","claimVoucherBtn","claimRewardBtn"].forEach(id=>{
    document.getElementById(id).disabled = false;
  });
};

// Check Pool
document.getElementById("poolBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(VOUCHER_CONTRACT, ABI, provider);
    const bal = await contract.getPoolBalance();
    log("Pool balance: " + ethers.utils.formatUnits(bal,18) + " HBIRD");
  } catch (e) {
    log("‚ùå Pool check failed: " + e.message);
  }
};

// Auto Nonce
document.getElementById("nonceBtn").onclick = async () => {
  try {
    const contract = new ethers.Contract(VOUCHER_CONTRACT, ABI, provider);
    let n = 0;
    while (await contract.usedNonces(account, n)) n++;
    document.getElementById("manualNonce").value = n;
    log("Auto Nonce: " + n);
  } catch (e) {
    log("‚ùå Auto Nonce error: " + e.message);
  }
};

// Claim Voucher
document.getElementById("claimVoucherBtn").onclick = async () => {
  try {
    const points = document.getElementById("pointsInput").value;
    let nonce = document.getElementById("manualNonce").value;
    const backendUrl = "https://birdfun.vercel.app/api/sign";
    const url = `${backendUrl}?player=${account}&points=${points}&nonce=${nonce}&contractAddress=${VOUCHER_CONTRACT}`;
    
    log("Fetching voucher...");
    const res = await fetch(url);
    const voucher = await res.json();
    log("Voucher: " + JSON.stringify(voucher));

    const contract = new ethers.Contract(VOUCHER_CONTRACT, ABI, signer);
    const tx = await contract.redeemVoucher(
      voucher.player,
      voucher.points,
      voucher.tokenAmount,
      voucher.nonce,
      voucher.expiry,
      voucher.signature
    );
    log("‚õìÔ∏è Voucher TX sent: " + tx.hash);
    const rc = await tx.wait();
    log("‚úÖ Voucher Claimed, block " + rc.blockNumber);
  } catch (e) {
    log("‚ùå Voucher claim error: " + e.message);
  }
};

// Claim Reward HBIRD
document.getElementById("claimRewardBtn").onclick = async () => {
  try {
    const amount = document.getElementById("amountInput").value;
    let nonce = 1;
    const contractRead = new ethers.Contract(HBIRD_CONTRACT, ABI, provider);
    while (await contractRead.usedNonces(account, nonce)) nonce++;
    log("Using nonce: " + nonce);

    const backendUrl = "https://birdfunbackend.vercel.app/api/sign";
    const url = `${backendUrl}?player=${account}&amount=${amount}&nonce=${nonce}&contractAddress=${HBIRD_CONTRACT}`;
    
    log("Fetching reward voucher...");
    const res = await fetch(url);
    const voucher = await res.json();
    log("Reward voucher: " + JSON.stringify(voucher));

    const contract = new ethers.Contract(HBIRD_CONTRACT, ABI, signer);
    const tx = await contract.claimReward(
      voucher.amountWei,
      voucher.nonce,
      voucher.expiry,
      voucher.signature
    );
    log("‚õìÔ∏è Reward TX sent: " + tx.hash);
    const rc = await tx.wait();
    log("‚úÖ Reward Claimed, block " + rc.blockNumber);
  } catch (e) {
    log("‚ùå Reward claim error: " + e.message);
  }
};
</script>
</body>
</html>