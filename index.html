<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>HBIRD Claim Test</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    body { font-family: monospace; padding:20px; background:#111; color:#eee; }
    button { margin:8px 0; padding:10px; font-size:16px; border-radius:8px; cursor:pointer; }
    #debug { background:#000; color:#0f0; padding:10px; height:300px; overflow:auto; white-space:pre-wrap; }
  </style>
</head>
<body>
  <h2>HBIRD Claim Test</h2>
  <button id="connectBtn">üîå Connect Wallet</button><br>
  <button id="claimBtn" disabled>üéÅ Claim Reward</button>
  <h3>Debug Log</h3>
  <div id="debug"></div>

<script>
const debugBox = document.getElementById("debug");
function log(msg) {
  console.log(msg);
  debugBox.textContent += `[${new Date().toISOString()}] ${msg}\n`;
  debugBox.scrollTop = debugBox.scrollHeight;
}

let provider, signer, account;

const CONTRACT_ADDR = "0xb9ccd00c2016444f58e2492117b49da317f4899b"; // HBIRD Reward contract
const ABI = [
  "function claimReward(uint256 amount,uint256 nonce,uint256 expiry,bytes signature) external",
  "function usedNonces(address player,uint256 nonce) view returns (bool)"
];

// Helios chain data
const heliosChain = {
  chainId: "0xa410", // 42000
  chainName: "Helios Testnet",
  nativeCurrency: { name: "Helios", symbol: "tHELIOS", decimals: 18 },
  rpcUrls: ["https://testnet1.helioschainlabs.org"],
  blockExplorerUrls: ["https://explorer.helioschainlabs.org"],
};

// Connect wallet
document.getElementById("connectBtn").onclick = async () => {
  if (!window.ethereum) {
    return log("‚ùå Wallet not found (OKX/Bitget/MetaMask)");
  }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  account = await signer.getAddress();
  log("üîå Wallet connected: " + account);

  const net = await provider.getNetwork();
  if (net.chainId !== 42000) {
    log("‚ö†Ô∏è Wrong network. Switching to Helios...");
    await window.ethereum.request({
      method: "wallet_addEthereumChain",
      params: [heliosChain]
    });
  } else {
    log("‚úÖ Already on Helios Testnet");
  }

  document.getElementById("claimBtn").disabled = false;
};

// Claim reward
document.getElementById("claimBtn").onclick = async () => {
  try {
    log("Requesting voucher from backend...");
    const backendUrl = "https://birdfunbackend.vercel.app/api/sign";

    // cari nonce otomatis
    let nonce = 1;
    const contractRead = new ethers.Contract(CONTRACT_ADDR, ABI, provider);
    while (await contractRead.usedNonces(account, nonce)) {
      nonce++;
    }
    log("Using nonce: " + nonce);

    // request voucher dari backend
    const url = `${backendUrl}?player=${account}&amount=100&nonce=${nonce}&contractAddress=${CONTRACT_ADDR}`;
    const res = await fetch(url);
    const voucher = await res.json();
    log("Voucher: " + JSON.stringify(voucher, null, 2));

    if (!voucher.signature) {
      return log("‚ùå Voucher gagal dibuat: " + JSON.stringify(voucher));
    }

    log("‚ö° Sending tx claimReward...");
    const contract = new ethers.Contract(CONTRACT_ADDR, ABI, signer);
    const tx = await contract.claimReward(
      voucher.amountWei,
      voucher.nonce,
      voucher.expiry,
      voucher.signature
    );
    log("‚õìÔ∏è TX sent: " + tx.hash);
    const receipt = await tx.wait();
    log("‚úÖ Claim success in block " + receipt.blockNumber);
  } catch (err) {
    log("‚ùå Error: " + (err.message || err));
  }
};
</script>
</body>
</html>